# Application Design & Architecture Guide

このプロジェクトでは、保守しやすく拡張しやすい構成にするため、**Feature-Sliced Design (FSD)** を採用しています。

## アプリケーションの前提・目的

本アプリケーションは、コーエーテクモゲームスの競馬シミュレーションゲーム「Winning Post」等のプレイデータを元に、仲間内で仮想的な競馬・馬券遊びを行うためのシステムです。
実際の金銭のやり取りは発生せず、ゲーム内のレース結果を元に架空の通貨を賭けて楽しむことを目的としています。

## FSDの基本概念

FSDは、アプリケーションを「レイヤー」「スライス」「セグメント」の3つの考え方で整理する設計手法です。
最も重要なルールは、**依存方向を一方向にすること（上位レイヤーから下位レイヤーへのみ依存する）** です。

### レイヤー構成（上から順に上位）

1.  **App (`src/app`)**: アプリケーションの初期化、ルーティング、グローバル設定。
    - _依存ルール_: すべての下位レイヤーを使用可能。
2.  **(Pages)**: Next.js App Routerでは `src/app` がこの役割を兼ねます。各ページごとの構成。
3.  **Features (`src/features`)**: ユーザーにとって価値のある**機能・アクション**（例: ログイン、馬券購入、管理者による着順確定）。
4.  **Entities (`src/entities`)**: ビジネスドメインの**データモデル・表示**（例: ユーザー、競走馬、競馬場、レース）。
5.  **Shared (`src/shared`)**: 特定のドメインに依存しない共通コード（UIキット、設定、DB接続、ユーティリティ）。
    - _依存ルール_: どのレイヤーにも依存してはいけない（最下層）。

補足: FSD上の `Widgets` レイヤーは概念として有効ですが、現行リポジトリでは未採用です。

---

## 現在のディレクトリ構成の解説

このプロジェクトで採用している構成と、配置の意図を説明します。

### 1. `src/app` (App Layer & Pages Layer)

Next.jsのApp Router規約に基づくディレクトリです。FSDの「App」と「Pages」の役割を担います。

- **役割**: ルーティング定義、レイアウト、ページ全体の組み立て。
- **設計意図**: ここには複雑なロジックを書かず、下位レイヤー（Features/Entities）の部品を組み合わせる役割に絞ります。
- **例**: `admin/events/page.tsx` (イベント管理ページ)

### 2. `src/features` (Features Layer)

- **役割**: **「ユーザーが実行するアクション」** を伴う機能モジュール。
- **主な構成**:
  - `admin`: 管理画面機能（イベント・レース・出走・オッズ・ユーザー管理）
  - `auth`: ログイン・ログアウト・ゲスト認証
  - `betting`: 馬券購入、点数計算、オッズ連携
  - `economy`: 配布、借入、ウォレット
  - `forecasts`: 予想入力・表示
  - `ranking`: ランキング取得・公開モード連携
  - `stats`: 戦績表示
  - `user`: ユーザープロフィール編集
- **なぜここか？**: これらはアプリの中核となる処理であり、単なる表示よりも一段深い「機能」をまとめるためです。

### 3. `src/entities` (Entities Layer)

- **役割**: ビジネスデータの**「表示」** やデータの型定義。
- **配置したもの**:
  - `bet`: 馬券ドメイン（券種、組み合わせ、配当）
  - `horse`: 競走馬ドメイン
  - `race`: レースドメイン
  - `ranking`: ランキング表示モデル
  - `user`: ユーザードメイン
  - `wallet`: ウォレット計算ロジック
- **なぜここか？**: 競馬システムでは「馬」や「レース」が中心となるため、型や表示に関する共通ルールをここで管理します。

### 4. `src/shared` (Shared Layer)

- **役割**: プロジェクト全体で使われる、再利用性の高い部品や設定。
- **配置したもの**:
  - `ui/`: shadcn/uiベースの共通コンポーネント
  - `db/schema.ts`: データベーススキーマ定義
  - `constants/`: 競馬場（Venue）や格付け（Grade）の定数
- **なぜここか？**: これらは多くの場所から使う共通部品のため、最下層の Shared に置いています。

---

## テクニカル・ディテール

### Server-Sent Events (SSE) によるリアルタイム同期

管理画面でのアクションを即座にユーザー画面へ反映させるため、以下のイベントを配信しています。

- `RACE_CLOSED`: レースの受付終了（購入ボタンの無効化）
- `RACE_REOPENED`: レースの受付再開（購入ボタンの再有効化）
- `RACE_FINALIZED`: 配当の確定（結果表示の準備完了）
- `RACE_BROADCAST`: 全ユーザーへの結果発表（自動ポップアップ表示）

#### 実装詳細: Singleton Emitter

Next.js の Server Actions や API Routes はステートレスに動くため、リクエストごとに `EventEmitter` が作り直される課題がありました。
そこで、`global` を使ったシングルトン（`src/shared/lib/sse/event-emitter.ts`）を採用しています。
これにより、タイマー実行（バックグラウンド）とAPI経由の手動実行（フォアグラウンド）で、同じイベントを確実に配信できます。

### UI標準化とFSDの適用

- **Shared UI**: `src/shared/ui` 配下のコンポーネントのみで構築することでデザインの一貫性を担保。
- **即BET (Soku-BET)**: 即時投票に特化したカード型UIを採用し、競馬場・レース番号・条件を高い視認性で表示。
- **Terminology Sync**: 「会場」という一般的・曖昧な表現を「競馬場」という競馬専門用語に統一し、プロダクトの専門性を向上。
