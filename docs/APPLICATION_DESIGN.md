# Application Design & Architecture Guide

このプロジェクトでは、フロントエンドのメンテナンス性と拡張性を高めるため、**Feature-Sliced Design (FSD)** というアーキテクチャパターンを採用しています。

## アプリケーションの前提・目的

本アプリケーションは、コーエーテクモゲームスの競馬シミュレーションゲーム「Winning Post」等のプレイデータを元に、仲間内で仮想的な競馬・馬券遊びを行うためのシステムです。
実際の金銭のやり取りは発生せず、ゲーム内のレース結果を元に架空の通貨を賭けて楽しむことを目的としています。

## FSDの基本概念

FSDは、アプリケーションを「レイヤー（Layers）」、「スライス（Slices）」、「セグメント（Segments）」の3階層で分割・整理する設計手法です。
最も重要なルールは **「依存の方向は一方向（上位レイヤーから下位レイヤーへのみ依存可能）」** という点です。

### レイヤー構成（上から順に上位）

1.  **App (`src/app`)**: アプリケーションの初期化、ルーティング、グローバル設定。
    - _依存ルール_: すべての下位レイヤーを使用可能。
2.  **(Pages)**: Next.js App Routerでは `src/app` がこの役割を兼ねます。各ページごとの構成。
3.  **Widgets (`src/widgets`)**: 複数のFeatureやEntityを組み合わせた独立したUIブロック（例: Header, Sidebar）。
4.  **Features (`src/features`)**: ユーザーにとって価値のある**機能・アクション**（例: ログイン、馬券購入、管理者による着順確定）。
5.  **Entities (`src/entities`)**: ビジネスドメインの**データモデル・表示**（例: ユーザー、競走馬、競馬場、レース）。
6.  **Shared (`src/shared`)**: 特定のドメインに依存しない共通コード（UIキット、APIクライアント、設定、DB接続）。
    - _依存ルール_: どのレイヤーにも依存してはいけない（最下層）。

---

## 現在のディレクトリ構成の解説

このプロジェクトで採用している具体的な構成と、その意図（なぜそこに置いたか）を解説します。

### 1. `src/app` (App Layer & Pages Layer)

Next.jsのApp Router規約に基づくディレクトリです。FSDの「App」と「Pages」の役割を担います。

- **役割**: ルーティング定義、レイアウト、ページ全体の組み立て。
- **設計意図**: ここには「複雑なロジック」を書かず、下位レイヤー（Features/Entities）から部品をインポートして配置するだけに留めます。
- **例**: `admin/events/page.tsx` (イベント管理ページ)

### 2. `src/widgets` (Widgets Layer)

- **役割**: ページ内で使われる大きなUIブロック。
- **現状**: 多くのコンポーネントはまだ `features` に配置されています（例: `AdminSidebar` は `src/features/admin/ui` に存在）。将来的にはここへ移動・統合する可能性があります。

### 3. `src/features` (Features Layer)

- **役割**: **「ユーザーが実行するアクション」** を伴う機能モジュール。
- **配置したもの**:
  - `auth`: ログイン・ログアウト処理
  - `betting`: 馬券購入ロジックと購入アクション
  - `admin/manage-venues`: 競馬場マスタの編集・登録アクション
  - `admin/manage-races`: レースの作成・着順確定アクション
  - `admin/manage-users`: ユーザー・ゲスト・権限管理
  - `admin/guest-codes`: ゲストコード発行・管理
  - `admin/manage-events`: イベント管理
  - `admin/manage-horses`: 馬マスタ管理
  - `admin/manage-horse-tags`: 馬タグ管理
  - `admin/manage-entries`: 出走登録・枠順管理
  - `admin/manage-bets`: 馬券管理（全馬券の参照）
  - `admin/bet5`: BET5（5重勝単勝式）イベント管理
- **なぜここか？**: これらのアクションはビジネスロジックの中核であり、単なるデータの表示を超えた「振る舞い」をカプセル化するためです。

### 4. `src/entities` (Entities Layer)

- **役割**: ビジネスデータの**「表示」** やデータの型定義。
- **配置したもの**:
  - `user`: ユーザープロフィール表示
  - `horse`: 競走馬のステータス表示
  - `race`: レース情報の表示用コンポーネント
- **なぜここか？**: 競馬システムにおいて「馬」や「レース」は中心的な実体（Entity）です。ここではそれらがUI上でどのように表現されるかを管理します。

### 5. `src/shared` (Shared Layer)

- **役割**: プロジェクト全体で使われる、再利用性の高い部品や設定。
- **配置したもの**:
  - `ui/`: shadcn/uiベースの共通コンポーネント
  - `db/schema.ts`: データベーススキーマ定義
  - `constants/`: 競馬場（Venue）や格付け（Grade）の定数
- **なぜここか？**: これらはあらゆる場所から呼ばれる可能性があるため、最下層のSharedに置く必要があります。

---

## テクニカル・ディテール

### Server-Sent Events (SSE) によるリアルタイム同期

管理画面でのアクションを即座にユーザー画面へ反映させるため、以下のイベントを配信しています。

- `RACE_CLOSED`: レースの受付終了（購入ボタンの無効化）
- `RACE_REOPENED`: レースの受付再開（購入ボタンの再有効化）
- `RACE_FINALIZED`: 配当の確定（結果表示の準備完了）
- `RACE_BROADCAST`: 全ユーザーへの結果発表（自動ポップアップ表示）

#### 実装詳細: Singleton Emitter

Next.js の Server Actions や API Routes はステートレスに動作するため、各リクエストで `EventEmitter` が再生成されてしまう問題がありました。
これを解決するため、`global` オブジェクトを利用したシングルトンパターン (`src/lib/sse/event-emitter.ts`) を採用しています。
これにより、タイマーによる自動実行（バックグラウンド）と、API経由の手動実行（フォアグラウンド）の間で、確実にイベントを共有・配信しています。

### UI標準化とFSDの適用

- **Shared UI**: `src/shared/ui` 配下のコンポーネントのみで構築することでデザインの一貫性を担保。
- **即BET (Soku-BET)**: 即時投票に特化したカード型UIを採用し、競馬場・レース番号・条件を高い視認性で表示。
- **Terminology Sync**: 「会場」という一般的・曖昧な表現を「競馬場」という競馬専門用語に統一し、プロダクトの専門性を向上。
