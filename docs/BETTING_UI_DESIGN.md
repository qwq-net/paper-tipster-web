# 馬券購入UIおよび計算ロジック仕様書

## 1. システム概要

本仕様書は、競馬の馬券購入UIにおける入力制御と購入点数の計算ロジックを定義します。
JRA（日本中央競馬会）のフォーメーション入力方式に準拠し、チェックボックスの選択状態から有効な組み合わせを動的に計算します。

---

## 2. UI構成とデータマッピング

### タブ構成と入力列の定義

各券種で、テーブル内の3つのチェックボックス（Col1, Col2, Col3）は次の役割を持ちます。

| 券種   | Col1 (1列目) | Col2 (2列目) | Col3 (3列目) | 計算モデル        |
| ------ | ------------ | ------------ | ------------ | ----------------- |
| 単勝   | 1着候補      | 未使用       | 未使用       | 単一選択          |
| 複勝   | 3着以内候補  | 未使用       | 未使用       | 単一選択          |
| 枠連   | 1枠目        | 2枠目        | 未使用       | 組み合わせ        |
| 馬連   | 1頭目        | 2頭目        | 未使用       | 組み合わせ        |
| ワイド | 1頭目        | 2頭目        | 未使用       | 組み合わせ        |
| 馬単   | 1着候補      | 2着候補      | 未使用       | 順列              |
| 3連複  | 1頭目        | 2頭目        | 3頭目        | 組み合わせ        |
| 3連単  | 1着候補      | 2着候補      | 3着候補      | 順列              |
| BET5   | R1〜R5 1着   | 未使用       | 未使用       | 5レース組み合わせ |

---

## 3. 購入点数算出アルゴリズム

### 3.1 フォーメーション展開の原則

ユーザーが各列で選択した馬番号（または枠番号）の集合を S1, S2, S3 とします。
全組み合わせを生成し、次の条件を満たすものだけを購入点数として数えます。

### 3.2 順列系（馬単・3連単）

選択された馬が重複しないパターンだけを抽出します。

馬単:

```latex
(n_{1}, n_{2}) \quad \text{s.t.} \quad n_{1} \in S_{1}, n_{2} \in S_{2}, n_{1} \neq n_{2}

```

3連単:

```latex
(n_{1}, n_{2}, n_{3}) \quad \text{s.t.} \quad n_{1} \in S_{1}, n_{2} \in S_{2}, n_{3} \in S_{3}, n_{1} \neq n_{2} \neq n_{3} \neq n_{1}

```

### 3.3 組み合わせ系（馬連・ワイド・3連複）

選択された馬が重複せず、順序を無視して一意になるパターンを抽出します。通常は昇順にソートして重複を除去します。

馬連/ワイド:

```latex
\{n_{1}, n_{2}\} \quad \text{s.t.} \quad n_{1} \in S_{1}, n_{2} \in S_{2}, n_{1} \neq n_{2}

```

3連複:

```latex
\{n_{1}, n_{2}, n_{3}\} \quad \text{s.t.} \quad n_{1} \in S_{1}, n_{2} \in S_{2}, n_{3} \in S_{3}, n_{1} \neq n_{2} \neq n_{3} \neq n_{1}

```

### 3.4 枠連の特殊例外（ゾロ目処理）

枠連で S1 と S2 に同じ枠番 b が選択された場合、その枠に2頭以上が出走している時のみ「b-b」を有効にします。1頭以下の場合は除外します。

---

## 4. ステート管理とバリデーション

### フロントエンド（React/Next.js）の責務

- リアルタイム計算: チェック状態が変わるたび（onChange）に点数を再計算し、合計金額（点数 × 単価）を表示します。
- 排他制御: 枠連以外の券種では列ごとの選択を独立させ、計算ロジック側で重複を除外します。
- 順列系（馬単など）: 各列に1つ以上の選択があり、重複を除外した有効な組み合わせが存在することを前提にします。

---

## 5. リアルタイム状態同期 (Real-time Sync)

馬券購入画面は、Server-Sent Events (SSE) でレース状態を監視し、管理者の操作に即時反応します。

- **受付終了 (`RACE_CLOSED`)**:
  - 全ての入力をロック（disabled）。
  - 「受付終了」の通知を表示し、購入ボタンを非表示化。
- **受付再開 (`RACE_REOPENED`)**:
  - 入力ロックを解除し、購入可能な状態に自動復帰。
  - カウントダウンタイマーが再設定されている場合は、タイマー表示を更新。
- **結果確定 (`RACE_BROADCAST`)**:
  - 払戻結果の自動ポップアップ（モーダル）を表示。

### 5.1 即BET（簡易投票）UI

即BET画面では、レース情報の優先度に基づき、直感的に操作できるカードデザインを採用します。

競馬レース情報の優先度は次の通りです。

> 競馬場 → 番号 → レース名 → グレード → コース条件

この優先度に従って、次の順序で表示します。

- **日付非表示**: 開催中のイベントを表示するため、日付は省略。
- **レース番号**: 「1R」「2R」のように短縮表記し、バッジスタイルで強調。
- **コース情報**: 「芝 2000m」のように、馬場状態→距離の順で記載。
- **競馬場名**: バッジではなく、プレーンテキストで表示。

---

## 6. 購入馬券の表示 (Purchased Ticket Display)

### 6.1 買い目の圧縮表示 (Simple Formation Display)

購入フローがフォーメーション形式に基づくため、購入馬券（BetGroup）は**各順で選択された馬番の全集合**として簡潔に表示します。

- **表示ロジック**:
  - 1つのBetGroupに含まれる全買い目から、1着目・2着目・3着目（券種による）ごとにユニークな馬番リストを抽出します。
  - 複雑な行分割や条件分岐は行わず、常に1つのBetGroupを**1行のフォーメーション形式**で表現します。
  - 例: `1-2-3` と `1-2-4` を購入した場合 → `1 - 2 - 3,4` と表示。
  - 例: `1-2-3` と `4-5-6` が同一グループにある場合（※） → `1,4 - 2,5 - 3,6` と表示。
    - ※現行の入力仕様では発生しにくいですが、仕様上は「着順ごとの和集合」で表現します。

- **ソート順**: 各列内の数字は昇順（ASC）で表示します。
- **的中表示**: グループ内に的中が含まれる場合、行全体（またはグループヘッダー）を「的中」として強調します。

### 6.2 視認性の向上

- **枠番カラー (Bracket Colors)**: 馬番の表示には、JRA標準の枠番カラー（1枠:白、2枠:黒、3枠:赤、4枠:青、5枠:黄、6枠:緑、7枠:橙、8枠:桃）を背景色として適用する。
- **グループ表示**: 1回の購入操作（1トランザクション）ごとに「購入単位（BetGroup）」としてまとめられ、アコーディオン形式で表示される。
- **金額表記**: グループ単位のヘッダーには、`単価 × 点数 = 合計金額` の内訳を表示する。

### 6.3 グリッドフォーメーション表示

買い目を競馬新聞のフォーメーション表に近い形で視覚化します。

- **レイアウト**: 各ポジション（1着・2着・3着）ごとにグリッドを構成し、左から右へ `▶` アイコンで接続する。
- **グリッド列数**: 各ポジション内の馬番数に応じて自動的に列数を調整する。
  - 1〜2頭: 1列
  - 3〜4頭: 2列
  - 5〜6頭: 2〜3列（レスポンシブ）
  - 7頭以上: 3〜4列（レスポンシブ）
- **馬番ブロック**: 各馬番は `h-7 w-8` の正方形に近いブロックとして表示し、フォント（`font-mono`）と枠番カラーを適用する。
- **横スクロール**: 馬番数が多く画面幅を超える場合は、水平スクロールで全体を確認できるようにします。
