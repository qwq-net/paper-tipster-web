# 馬券購入UIおよび計算ロジック仕様書

## 1. システム概要

本仕様書は、競馬の馬券購入UIにおける入力制御および購入点数の算出ロジックを定義する。
現実のJRA（日本中央競馬会）のフォーメーション入力方式に準拠し、チェックボックスの選択状態から有効な組み合わせを動的に算出する。

---

## 2. UI構成とデータマッピング

### タブ構成と入力列の定義

各券種において、テーブル内の3つのチェックボックス（Col1, Col2, Col3）は以下の役割を持つ。

| 券種   | Col1 (1列目) | Col2 (2列目) | Col3 (3列目) | 計算モデル |
| ------ | ------------ | ------------ | ------------ | ---------- |
| 単勝   | 1着候補      | 未使用       | 未使用       | 単一選択   |
| 複勝   | 3着以内候補  | 未使用       | 未使用       | 単一選択   |
| 枠連   | 1枠目        | 2枠目        | 未使用       | 組み合わせ |
| 馬連   | 1頭目        | 2頭目        | 未使用       | 組み合わせ |
| ワイド | 1頭目        | 2頭目        | 未使用       | 組み合わせ |
| 馬単   | 1着候補      | 2着候補      | 未使用       | 順列       |
| 3連複  | 1頭目        | 2頭目        | 3頭目        | 組み合わせ |
| 3連単  | 1着候補      | 2着候補      | 3着候補      | 順列       |

---

## 3. 購入点数算出アルゴリズム

### 3.1 フォーメーション展開の原則

ユーザーが各列で選択した馬番号（または枠番号）の集合を S1, S2, S3 とする。
全組み合わせを生成し、以下の条件を満たすもののみを購入点数としてカウントする。

### 3.2 順列系（馬単・3連単）

選択された馬が互いに重複しないパターンを抽出する。

馬単:

```latex
(n_{1}, n_{2}) \quad \text{s.t.} \quad n_{1} \in S_{1}, n_{2} \in S_{2}, n_{1} \neq n_{2}

```

3連単:

```latex
(n_{1}, n_{2}, n_{3}) \quad \text{s.t.} \quad n_{1} \in S_{1}, n_{2} \in S_{2}, n_{3} \in S_{3}, n_{1} \neq n_{2} \neq n_{3} \neq n_{1}

```

### 3.3 組み合わせ系（馬連・ワイド・3連複）

選択された馬の集合に重複がなく、かつ順序を無視して一意になるパターンを抽出する。通常、昇順にソートして重複を除去する。

馬連/ワイド:

```latex
\{n_{1}, n_{2}\} \quad \text{s.t.} \quad n_{1} \in S_{1}, n_{2} \in S_{2}, n_{1} \neq n_{2}

```

3連複:

```latex
\{n_{1}, n_{2}, n_{3}\} \quad \text{s.t.} \quad n_{1} \in S_{1}, n_{2} \in S_{2}, n_{3} \in S_{3}, n_{1} \neq n_{2} \neq n_{3} \neq n_{1}

```

### 3.4 枠連の特殊例外（ゾロ目処理）

枠連において S1 と S2 で同じ枠番 b が選択された場合、その枠に2頭以上の馬が出走している場合のみ「b-b」の組み合わせを有効とする。1頭以下の場合は計算から除外する。

---

## 4. ステート管理とバリデーション

### フロントエンド（React/Next.js）の責務

- リアルタイム計算: チェックボックスの状態変更（onChange）のたびに点数を再計算し、合計金額（点数 × 単価）を表示する。
- 排他制御: 枠連以外の券種において、1つの列内での選択は独立させるが、計算ロジック側で重複を除外する。
- 順列系（馬単等）：各列に1つ以上のチェック、かつ重複を除外した有効な組み合わせが存在。

---

## 5. リアルタイム状態同期 (Real-time Sync)

馬券購入画面は、Server-Sent Events (SSE) を通じてレース状態を監視し、管理者の操作に即座に反応する。

- **受付終了 (`RACE_CLOSED`)**:
  - 全ての入力をロック（disabled）。
  - 「受付終了」の通知を表示し、購入ボタンを非表示化。
- **受付再開 (`RACE_REOPENED`)**:
  - 入力ロックを解除し、購入可能な状態に自動復帰。
  - カウントダウンタイマーが再設定されている場合は、タイマー表示を更新。
- **結果確定 (`RACE_BROADCAST`)**:
  - 払戻結果の自動ポップアップ（モーダル）を表示。

### 5.1 即PAT（簡易投票）UI

即PAT画面では、基本的な競馬レース情報優先度を元に、直感的な操作のために以下のカードデザインを採用する。

競馬レース情報優先度とは以下とする

> 場所 → 番号 → レース名 → グレード → コース条件

これに従い、以下の順序で表示する。

- **日付非表示**: 開催中のイベントを表示するため、日付は省略。
- **レース番号**: 「1R」「2R」のように短縮表記し、バッジスタイルで強調。
- **コース情報**: 「芝 2000m」のように、馬場状態→距離の順で記載。
- **競馬場名**: バッジではなく、プレーンテキストで表示。
