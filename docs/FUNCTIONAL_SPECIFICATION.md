# 機能仕様書 (Functional Specification)

## 概要

本ドキュメントは、Paper Tipster アプリケーションの機能要件と仕様を定義します。
ユーザーおよび管理者が利用可能な機能、システムのアクション、およびデータフローについて記述します。

---

## 1. ユーザー機能 (User Features)

### 1.1 認証 (Authentication)

- **Discordログイン**: OAuthプロバイダーとしてDiscordを使用します。
- **ゲストログイン (簡易登録)**: 管理者が発行した「登録用コード」を使用してアカウントを作成・ログインします。
  - **共有コード**: 1つのコードを複数のユーザー（集まりの参加者など）に共有可能。
  - **識別**: 同じコードを使用したユーザーをグループとして識別可能。
  - **フロー**: コード・ユーザー名・絵文字パスワードを入力。
    - **新規**: その情報でアカウント作成。
    - **既存**: コードとユーザー名が一致する場合、パスワード検証してログイン。
  - **パスワード**: 絵文字キーパッドを使用した絵文字の組み合わせ（3〜6文字）。
  - **ユーザー名**: システム内で一意である必要があります（マイページからの変更時も重複チェックあり）。
- **自動登録**: 初回ログイン時に自動的にユーザーアカウントを作成します。
- **権限**: ゲストは `GUEST` ロールを持ちます。

### 1.2 イベントとウォレット (Event & Wallet)

- **イベント通貨**: イベントごとに独立したウォレット（財布）を持ちます。
- **お小遣い (Claim)**: イベントに参加することで初期資金（イベント通貨）を受け取ることができます。
- **取引履歴**: 各イベントウォレット内での資金移動（配布、ベット、払戻）を確認できます。

### 1.3 馬券購入 (Betting)

実際の競馬に準拠したUIとロジックで馬券を購入できます。

- **購入フロー**:
  1. レース選択
  2. 券種選択（単勝、複勝、枠連、馬連、馬単、ワイド、3連複、3連単）
  3. 馬番/枠番選択（フォーメーション入力対応）
  4. **自動計算**: 選択内容に基づき、有効な組み合わせ点数をリアルタイムで計算します。
  5. 金額入力と購入確定
- **即BET (Soku-BET)**:
  - 開催中のレースに特化したカード型UIで、競馬場・レース番号・条件を確認しながら即座に投票画面へ遷移可能。
- **制限事項**:
  - 所持金を超える購入はできません。
  - 受付終了（締め切り）後は購入できません。
  - **SSE連携**: サーバーからの通知に基づき、画面をロック/アンロックします。
  - `RACE_CLOSED`: 受付終了メッセージを表示し、購入ボタンを無効化。
  - `RACE_REOPENED`: ロックを解除し、入力を再び有効化。
- **待機画面への導線**: 購入完了後、または購入画面から待機画面へ遷移できます。

### 1.5 BET5 (5重勝単勝式)

指定された5つのレースの1着をすべて当てる投票形式です。

- **対象**: イベント管理者が指定した5レース。
- **投票方式**: 各レースで1頭以上を選択する「フォーメーション」方式。
- **点数計算**: (R1点数 × R2点数 × ... × R5点数) × 100pt。
- **配当**: 的中者全員でポット（売上 + イベント単位の累計キャリーオーバー）を山分けします。
- **UI**: 5つのタブを切り替えて各レースの馬を選択する専用UI。

### 1.4 レース待機・結果確認 (Standby & Results)

- **待機画面**:
  - レース情報の表示（競馬場、レース名、発走予定/締切）。
  - リアルタイムなステータス表示（待機中 / 確定済み）。
  - **着順表示**: 着順が確定すると「着順速報」として表示されます。馬番には枠色が反映されます。払戻確定後も「確定着順」として表示が維持され、リロード時も同様に表示されます。
- **結果発表**:
  - **SSE連携**: サーバーから `RACE_BROADCAST` イベントを受信すると、自動的に結果モーダル（払戻詳細）を表示します。
  - **払戻結果**: 的中した組み合わせと配当金額を確認できます。

### 1.5 ランキング確認 (Ranking)

参加イベントの現在の順位を確認できます。

- **表示モード**: 管理者の設定により表示内容が異なります。
  - **非公開**: ランキングは表示されません。
  - **匿名公開**: 名前が伏せられた状態でランキングが表示されます（自分の名前のみ表示）。
  - **完全公開**: 全参加者の名前と順位が表示されます。
- **リアルタイム更新**: 管理者が表示モードを変更すると、画面が自動的に更新されます。

---

## 2. 管理者機能 (Admin Features)

管理者権限 (`ADMIN` ロール) を持つユーザーのみがアクセス可能です。

### 2.1 ユーザー・ゲスト・権限管理

- **ユーザー一覧**: 登録ユーザーを確認できます。以下のタブで表示を切り替え可能。
  - 通常ユーザー (USER, ADMIN, TIPSTER)
  - ゲスト (GUEST)
  - AI (AI_TIPSTER, AI_USER)
- **権限変更**: ユーザーをAdminに昇格させることができます。
- **ゲストコード発行**: ゲスト登録用のコードを発行・管理できます。
  - コード発行: タイトル（用途）を指定して共有用コードを発行。
  - コード一覧: 発行済みコードの確認、無効化が可能。
  - **無効化**: コードを無効化すると、そのコードを使った**新規登録**ができなくなります。
  - **ユーザー一括凍結**: 特定のコードで登録した全ユーザーを一括で凍結（Ban）し、ログイン不可にすることができます。
- **ユーザー管理**: ユーザー個別の凍結・解除も可能です。

### 2.2 競馬場 (Racecourse) 管理

- **競馬場マスタ登録**: 名前、略称、コード、地域（東日本/西日本/海外）、デフォルトの回り方向を管理。
- **データ依存性**: レース定義やレースインスタンスの基本データとして使用されます。

### 2.3 馬タグ (Horse Tag) 管理

- **タグマスタ登録**: 脚質、特性、来歴などのカテゴリ別にタグの内容を管理。
- **馬マスタ管理との連携**: 登録されたタグは馬の編集フォームで選択肢として表示されます。

### 2.4 競走馬 (Horse) マスタ管理

- **馬データ登録**: 名前、性別、年齢、種別（実在/非実在）、出身、タグ、血統（父/母）、備考を管理します。
- **自動集計**: レース結果に基づき、勝ち鞍（G1優勝など）が自動的に集計・表示されます。
- **編集・削除**: 登録情報の修正および削除が可能です。

### 2.5 レースマスタ管理 (Race Master)

- **レースマスタ登録**: レース名、グレード、種別、デフォルトの距離・馬場種類・競馬場・回り方向を保持。
- **効率化**: 重賞などの決まった条件を定義しておくことで、個別のレース作成時の入力を簡略化します。

### 2.6 イベント (Event) 管理

- **イベント作成・編集**: イベント名、開催日、初期配布金額を設定します。編集画面では、基本情報に加え、ステータス変更やランキングの公開/非公開設定も一元管理できます。
- **イベント周期**: 特定の集まりや期間をイベントとして定義し、参加者への一括資金配布、ステータス変更（準備中/開催中/終了）を行います。
- **ステータス管理**:
  - `SCHEDULED` (準備中): 公開前
  - `ACTIVE` (開催中): ユーザーが参加・購入可能
  - `COMPLETED` (終了): アーカイブ
- **ランキング公開設定**:
  - `HIDDEN`: 非公開 (デフォルト)
  - `ANONYMOUS`: 匿名公開 (自分の順位と名前のみ表示、他ユーザーはマスク)
  - `FULL`: 完全公開 (全員の順位と名前を表示)

### 2.7 オッズ管理 (Odds Management)

- **デフォルト保証オッズ設定**: システム全体で適用される、新規レース作成時のデフォルト保証オッズを管理します。
- **レース別設定**: 各レースの編集画面で、そのレース独自の保証オッズを上書き設定することができます。

### 2.8 レース (Race Instance) 管理

- **レース作成**: 特定のイベントと競馬場に紐付けてインスタンスを作成。レース定義からの値継承およびオーバーライドが可能。
- **基本情報**: 開催日、競馬場、レース番号、レース名、距離、コース（芝/ダート）、馬場状態、発走時刻。
- **出走馬管理 (Race Entry)**: ドラッグ＆ドロップUIによる出走馬の割り当て、枠順・馬番の設定。アコーディオンリスト形式で、レース番号（1Rなど）や登録頭数を一目で確認可能。
- **ステータス遷移**:
- **出走前 (SCHEDULED)**: レース前、馬券購入可能。
- **開催中 (ACTIVE)**: レース中、または直前。
- **締切済み (CLOSED)**: 馬券購入締切、結果入力待ち。
- **着順確定 (RANKING_CONFIRMED)**: 着順が入力・確定されたが、払戻が未確定の状態。
- **払戻確定 (FINALIZED)**: 払戻計算が完了し、ウォレットに残高が反映された状態。
- **中止 (CANCELLED)**: レースが中止になった状態。

### 2.6 出走管理 (Race Entry)

- **出走馬登録**: Drag & Drop (DnD) UIを使用して、登録済み競走馬をレースに割り当てます。
- **枠順確定**: JRAルール等に基づいた枠の割り当て（現在は手動または簡易ロジック）。
- **レース表示**: アコーディオンリスト形式で、レース番号（1Rなど）や登録頭数を一目で確認可能。

### 2.8 レース進行・着順確定 (Operation)

- **リアルタイム操作**: 受付開始/終了（手動・タイマー）、着順入力、払戻計算、結果配信（SSE）の全行程をワンストップで管理。

1. **受付管理**:
   - **キッチンタイマー**: 「+5分」「+10分」などのボタンで指定時間後に自動で締め切る設定が可能。
   - **受付終了**: 手動またはタイマーで実行。全ユーザーに `RACE_CLOSED` を送信。
   - **受付再開**: 誤操作等のリカバリー用。ステータスを戻し、全ユーザーに `RACE_REOPENED` を送信。
2. **着順操作**: DnDで出走馬の着順を並べ替えます。
3. **着順確定**: 着順を確定し、DBに保存します。この段階ではまだ配当は配布されません。
4. **払戻確定 (Finalize Payout)**:
   - 的中判定と配当計算（パリミュチュエル方式または設定値）を行い、ユーザーのウォレットに配当金を加算 (`PAYOUT` 取引) します。
   - **特払い (的中者なし)**: 的中者がいない賭け式の売上は払い戻されず、0円（不的中）として扱われます。その売上全額はイベントのキャリーオーバーとして蓄積され、BET5の配当ポットに加算されます。
   - **SSE送信**: 全ユーザーに `RACE_BROADCAST` イベントを送信し、結果発表（払戻詳細モーダル表示）を行います。

### 2.9 馬券管理 (Betting Management)

- **一覧確認**: 管理者は、レースごとに全ユーザーの購入馬券（購入内容、金額、ユーザー名）を一覧で確認できます。
- **詳細確認**: 個別の馬券のステータスや的中の有無を確認できます。

---

## 3. システム・アーキテクチャ概要

### 3.1 技術スタック

- **Frontend**: Next.js (App Router), React, Tailwind CSS
- **Backend**: Next.js Server Actions, Route Handlers
- **Database**: PostgreSQL, Drizzle ORM
- **Authentication**: Auth.js (NextAuth)
- **Real-time**: Server-Sent Events (SSE)

### 3.2 ディレクトリ構成 (Feature-Sliced Design)

- `src/app`: ルーティングとページ構成
- `src/features`: 機能単位のモジュール (auth, betting, admin, economy)
- `src/entities`: データモデルと表示コンポーネント (user, horse 等)
- `src/shared`: 共有UI、設定、ユーティリティ

---

## 4. 未実装・検討中機能

- **戦績確認**: ユーザー自身の過去の勝敗・回収率などの確認画面。
