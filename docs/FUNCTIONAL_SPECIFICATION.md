# 機能仕様書 (Functional Specification)

## 概要

本ドキュメントは、Japan Ranranru Racing Association (JRRA) アプリケーションの機能要件と仕様を定義します。
ユーザーおよび管理者が利用可能な機能、システムのアクション、およびデータフローについて記述します。

---

## 1. ユーザー機能 (User Features)

### 1.1 認証 (Authentication)

- **Discordログイン**: OAuthプロバイダーとしてDiscordを使用します。
- **ゲストログイン (簡易登録)**: 管理者が発行した「登録用コード」を使用してアカウントを作成・ログインします。
- **ゲストログイン (簡易登録)**: 管理者が発行した「登録用コード」を使用してアカウントを作成・ログインします。
  - **共有コード**: 1つのコードを複数のユーザー（集まりの参加者など）に共有可能。
  - **識別**: 同じコードを使用したユーザーをグループとして識別可能。
  - **フロー**: コード・ユーザー名・絵文字パスワードを入力。
    - **新規**: その情報でアカウント作成。
    - **既存**: コードとユーザー名が一致する場合、パスワード検証してログイン。
  - **パスワード**: 絵文字キーパッドを使用した絵文字の組み合わせ（3〜6文字）。
  - **ユーザー名**: システム内で一意である必要があります（マイページからの変更時も重複チェックあり）。
- **自動登録**: 初回ログイン時に自動的にユーザーアカウントを作成します。
- **権限**: ゲストは `GUEST` ロールを持ちます。

### 1.2 イベントとウォレット (Event & Wallet)

- **イベント通貨**: イベントごとに独立したウォレット（財布）を持ちます。
- **お小遣い (Claim)**: イベントに参加することで初期資金を受け取ることができます。
- **取引履歴**: 各イベントウォレット内での資金移動（配布、ベット、払戻）を確認できます。

### 1.3 馬券購入 (Betting)

実際の競馬に準拠したUIとロジックで馬券を購入できます。

- **購入フロー**:
  1. レース選択
  2. 券種選択（単勝、複勝、馬連、馬単、ワイド、3連複、3連単）
  3. 馬番/枠番選択（フォーメーション入力対応）
  4. **自動計算**: 選択内容に基づき、有効な組み合わせ点数をリアルタイムで計算します。
  5. 金額入力と購入確定
- **制限事項**:
  - 所持金を超える購入はできません。
  - 受付終了（締め切り）後は購入できません。
  - **SSE連携**: サーバーからの通知に基づき、画面をロック/アンロックします。
  - `RACE_CLOSED`: 受付終了メッセージを表示し、購入ボタンを無効化。
  - `RACE_REOPENED`: ロックを解除し、入力を再び有効化。
- **待機画面への導線**: 購入完了後、または購入画面から待機画面へ遷移できます。

### 1.4 レース待機・結果確認 (Standby & Results)

- **待機画面**:
  - レース情報の表示（場所、レース名、発走時刻/締切）。
  - リアルタイムなステータス表示（待機中 / 確定済み）。
- **結果発表**:
  - **SSE連携**: サーバーから `RACE_BROADCAST` イベントを受信すると、自動的に結果モーダルを表示します。
  - **払戻結果**: 的中した組み合わせと配当金額を確認できます。
- **ギャップ/課題**:
  - モーダルを閉じた際のリロード挙動については、現在 `router.refresh()` によるデータ更新のみ実装されています。

---

## 2. 管理者機能 (Admin Features)

管理者権限 (`ADMIN` ロール) を持つユーザーのみがアクセス可能です。

### 2.1 ユーザー管理

- **ユーザー一覧**: 登録ユーザーを確認できます。以下のタブで表示を切り替え可能。
  - 通常ユーザー (USER, ADMIN, TIPSTER)
  - ゲスト (GUEST)
  - AI (AI_TIPSTER, AI_USER)
- **権限変更**: ユーザーをAdminに昇格させることができます。
- **ゲストコード発行**: ゲスト登録用のコードを発行・管理できます。
  - コード発行: タイトル（用途）を指定して共有用コードを発行。
  - コード一覧: 発行済みコードの確認、無効化が可能。
  - **無効化**: コードを無効化すると、そのコードを使った**新規登録**ができなくなります。
  - **ユーザー一括凍結**: 特定のコードで登録した全ユーザーを一括で凍結（Ban）し、ログイン不可にすることができます。
- **ユーザー管理**: ユーザー個別の凍結・解除も可能です。

### 2.2 イベント管理

- **イベント作成・編集**: イベント名、開催日、初期配布金額を設定します。
- **ステータス管理**:
  - `SCHEDULED` (準備中): 公開前
  - `ACTIVE` (開催中): ユーザーが参加・購入可能
  - `COMPLETED` (終了): アーカイブ

### 2.3 馬 (Horse) 管理

- **競走馬登録**: 名前、性別、年齢、血統（父/母）、備考を管理します。
- **編集・削除**: 登録情報の修正および削除が可能です。

### 2.4 レース (Race) 管理

- **レース作成**: 特定のイベントに紐付けて管理されます。馬券購入はそのイベントのウォレットを使用します。
- **基本情報**: 開催日、場所、レース番号、レース名、距離、コース（芝/ダート）、馬場状態、発走時刻。
- **ステータス遷移**:
  1. `SCHEDULED` (出走前): 馬券購入可能
  2. `CLOSED` (受付終了): 馬券購入不可、着順確定待ち
  3. `FINALIZED` (払戻確定): 結果確定、配当配布済み

### 2.5 出走管理 (Race Entry)

- **出走馬登録**: Drag & Drop (DnD) UIを使用して、登録済み競走馬をレースに割り当てます。
- **枠順確定**: JRAルール等に基づいた枠の割り当て（現在は手動または簡易ロジック）。

### 2.6 レース進行・着順確定 (Race Operation)

レースの進行を管理するオペレーション画面です。

1. **受付管理**:
   - **キッチンタイマー**: 「+5分」「+10分」などのボタンで指定時間後に自動で締め切る設定が可能。
   - **受付終了**: 手動またはタイマーで実行。全ユーザーに `RACE_CLOSED` を送信。
   - **受付再開**: 誤操作等のリカバリー用。ステータスを戻し、全ユーザーに `RACE_REOPENED` を送信。
2. **着順操作**:
   - DnDで出走馬の着順を並べ替えます。
3. **着順確定**:
   - 着順を確定し、DBに保存します。この段階ではまだ配当は配布されません。
4. **払戻確定 (Finalize Payout)**:
   - 的中判定と配当計算（パリミュチュエル方式または設定値）を行います。
   - ユーザーのウォレットに配当金を加算 (`PAYOUT` 取引) します。
   - **SSE送信**: 全ユーザーに `RACE_BROADCAST` イベントを送信し、結果発表を行います。

---

## 3. システム・アーキテクチャ概要

### 3.1 技術スタック

- **Frontend**: Next.js (App Router), React, Tailwind CSS
- **Backend**: Next.js Server Actions, Route Handlers
- **Database**: PostgreSQL, Drizzle ORM
- **Authentication**: Auth.js (NextAuth)
- **Real-time**: Server-Sent Events (SSE)

### 3.2 ディレクトリ構成 (Feature-Sliced Design)

- `src/app`: ルーティングとページ構成
- `src/features`: 機能単位のモジュール (auth, betting, admin, economy)
- `src/entities`: データモデルと表示コンポーネント
- `src/shared`: 共有UI、設定、ユーティリティ

---

## 4. 未実装・検討中機能

- **戦績確認**: ユーザー自身の過去の勝敗・回収率などの確認画面。
- **馬券全体の閲覧**: 管理者がそのレースの全購入馬券を確認する機能。
