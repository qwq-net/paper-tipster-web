# 機能仕様書 (Functional Specification)

## 概要

本ドキュメントは、Japan Ranranru Racing Association (JRRA) アプリケーションの機能要件と仕様を定義します。
ユーザーおよび管理者が利用可能な機能、システムのアクション、およびデータフローについて記述します。

---

## 1. ユーザー機能 (User Features)

### 1.1 認証 (Authentication)

- **Discordログイン**: OAuthプロバイダーとしてDiscordを使用します。
- **自動登録**: 初回ログイン時に自動的にユーザーアカウントを作成します。
- **権限**: デフォルトは `USER` ロールです。

### 1.2 イベントとウォレット (Event & Wallet)

- **イベント通貨**: イベントごとに独立したウォレット（財布）を持ちます。
- **お小遣い (Claim)**: イベントに参加することで初期資金を受け取ることができます。
- **取引履歴**: 各イベントウォレット内での資金移動（配布、ベット、払戻）を確認できます。

### 1.3 馬券購入 (Betting)

実際の競馬に準拠したUIとロジックで馬券を購入できます。

- **購入フロー**:
  1. レース選択
  2. 券種選択（単勝、複勝、馬連、馬単、ワイド、3連複、3連単）
  3. 馬番/枠番選択（フォーメーション入力対応）
  4. **自動計算**: 選択内容に基づき、有効な組み合わせ点数をリアルタイムで計算します。
  5. 金額入力と購入確定
- **制限事項**:
  - 所持金を超える購入はできません。
  - 受付終了（締め切り）後は購入できません。
  - **SSE連携**: サーバーからのイベントを受信し、受付終了時は即座に購入ボタンを無効化します。
- **待機画面への導線**: 購入完了後、または購入画面から待機画面へ遷移できます。

### 1.4 レース待機・結果確認 (Standby & Results)

- **待機画面**:
  - レース情報の表示（場所、レース名、発走時刻/締切）。
  - リアルタイムなステータス表示（待機中 / 確定済み）。
- **結果発表**:
  - **SSE連携**: サーバーから `RACE_BROADCAST` イベントを受信すると、自動的に結果モーダルを表示します。
  - **払戻結果**: 的中した組み合わせと配当金額を確認できます。
- **ギャップ/課題**:
  - モーダルを閉じた際のリロード挙動については、現在 `router.refresh()` によるデータ更新のみ実装されています。

---

## 2. 管理者機能 (Admin Features)

管理者権限 (`ADMIN` ロール) を持つユーザーのみがアクセス可能です。

### 2.1 ユーザー管理

- **ユーザー一覧**: 登録ユーザーを確認できます。
- **権限変更**: ユーザーをAdminに昇格させることができます。

### 2.2 イベント管理

- **イベント作成・編集**: イベント名、開催日、初期配布金額を設定します。
- **ステータス管理**:
  - `SCHEDULED` (準備中): 公開前
  - `ACTIVE` (開催中): ユーザーが参加・購入可能
  - `COMPLETED` (終了): アーカイブ

### 2.3 馬 (Horse) 管理

- **競走馬登録**: 名前、性別、年齢、血統（父/母）、備考を管理します。
- **編集・削除**: 登録情報の修正および削除が可能です。

### 2.4 レース (Race) 管理

- **レース作成**: イベントに紐付かない独立したレースとして管理されますが、馬券購入はイベントウォレットを使用します。
- **基本情報**: 開催日、場所、レース番号、レース名、距離、コース（芝/ダート）、馬場状態、発走時刻。
- **ステータス遷移**:
  1. `SCHEDULED` (出走前): 馬券購入可能
  2. `CLOSED` (受付終了): 馬券購入不可、着順確定待ち
  3. `FINALIZED` (払戻確定): 結果確定、配当配布済み

### 2.5 出走管理 (Race Entry)

- **出走馬登録**: Drag & Drop (DnD) UIを使用して、登録済み競走馬をレースに割り当てます。
- **枠順確定**: JRAルール等に基づいた枠の割り当て（現在は手動または簡易ロジック）。

### 2.6 レース進行・着順確定 (Race Operation)

レースの進行を管理するオペレーション画面です。

1. **受付終了**:
   - 手動で締め切りを行うか、設定された時刻で自動的に締め切られます。
   - **SSE送信**: 全ユーザーに `RACE_CLOSED` イベントを送信します。
2. **着順操作**:
   - DnDで出走馬の着順を並べ替えます。
3. **着順確定**:
   - 着順を確定し、DBに保存します。この段階ではまだ配当は配布されません。
4. **払戻確定 (Finalize Payout)**:
   - 的中判定と配当計算（パリミュチュエル方式または設定値）を行います。
   - ユーザーのウォレットに配当金を加算 (`PAYOUT` 取引) します。
   - **SSE送信**: 全ユーザーに `RACE_BROADCAST` イベントを送信し、結果発表を行います。

---

## 3. システム・アーキテクチャ概要

### 3.1 技術スタック

- **Frontend**: Next.js (App Router), React, Tailwind CSS
- **Backend**: Next.js Server Actions, Route Handlers
- **Database**: PostgreSQL, Drizzle ORM
- **Authentication**: Auth.js (NextAuth)
- **Real-time**: Server-Sent Events (SSE)

### 3.2 ディレクトリ構成 (Feature-Sliced Design)

- `src/app`: ルーティングとページ構成
- `src/features`: 機能単位のモジュール (auth, betting, admin, economy)
- `src/entities`: データモデルと表示コンポーネント
- `src/shared`: 共有UI、設定、ユーティリティ

---

## 4. 未実装・検討中機能

- **戦績確認**: ユーザー自身の過去の勝敗・回収率などの確認画面。
- **馬券全体の閲覧**: 管理者がそのレースの全購入馬券を確認する機能。
- **ユーザー利用停止**: 明示的なBan機能（現在はDB直接操作が必要）。
